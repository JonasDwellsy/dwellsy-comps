<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dwellsy Comps Explorer</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3348;
    --text: #e4e6f0;
    --text-dim: #8b8fa8;
    --accent: #6c8cff;
    --accent-hover: #8ba5ff;
    --green: #4cdb8a;
    --orange: #ffb347;
    --red: #ff6b6b;
    --radius: 8px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .header-logo {
    height: 36px;
    width: auto;
    border-radius: 4px;
  }

  header .api-key-group {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  header .api-key-group label {
    font-size: 13px;
    color: var(--text-dim);
  }

  header .api-key-group input {
    width: 220px;
  }

  .layout {
    display: grid;
    grid-template-columns: 340px 1fr;
    grid-template-rows: 1fr;
    height: calc(100vh - 57px);
  }

  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .main-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .form-group label {
    font-size: 12px;
    color: var(--text-dim);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  input, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 10px;
    color: var(--text);
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }

  input:focus, select:focus {
    border-color: var(--accent);
  }

  input::placeholder {
    color: var(--text-dim);
    opacity: 0.6;
  }

  select { cursor: pointer; }

  .checkbox-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .checkbox-group label {
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    color: var(--text);
  }

  .checkbox-group input[type="checkbox"] {
    width: auto;
    accent-color: var(--accent);
  }

  button {
    cursor: pointer;
    border: none;
    border-radius: var(--radius);
    font-size: 14px;
    font-weight: 500;
    padding: 10px 16px;
    transition: background 0.15s;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    width: 100%;
  }

  .btn-primary:hover { background: var(--accent-hover); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    width: 100%;
    margin-top: 8px;
  }

  .btn-secondary:hover { background: var(--border); }
  .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Map */
  #map {
    flex: 1;
    min-height: 0;
  }

  /* Tabs below map */
  .bottom-panel {
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    height: 320px;
    min-height: 120px;
  }

  .tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    flex-shrink: 0;
  }

  .tab-btn {
    background: none;
    color: var(--text-dim);
    padding: 10px 20px;
    border-radius: 0;
    font-size: 13px;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
  }

  .tab-btn:hover { color: var(--text); }

  .tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-content {
    flex: 1;
    overflow: auto;
    padding: 16px;
    display: none;
  }

  .tab-content.active { display: block; }

  /* Stats */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }

  .stat-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
  }

  .stat-card .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .stat-card .stat-value {
    font-size: 22px;
    font-weight: 700;
  }

  .stat-card .stat-sub {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  /* Charts */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 16px;
  }

  .chart-container {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    position: relative;
    height: 220px;
  }

  /* Table */
  .comps-table-wrap {
    overflow: auto;
  }

  .comps-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
  }

  .comps-table th {
    position: sticky;
    top: 0;
    background: var(--surface2);
    text-align: left;
    padding: 8px 12px;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid var(--border);
  }

  .comps-table th:hover { color: var(--accent); }
  .comps-table th .sort-arrow { margin-left: 4px; }

  .comps-table td {
    padding: 7px 12px;
    border-bottom: 1px solid var(--border);
  }

  .comps-table tr:hover td {
    background: rgba(108, 140, 255, 0.05);
  }

  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
  }

  .status-badge.active { background: rgba(76,219,138,0.15); color: var(--green); }
  .status-badge.inactive { background: rgba(139,143,168,0.15); color: var(--text-dim); }

  /* Loading */
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15,17,23,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .hidden { display: none !important; }

  /* Resize handle */
  .resize-handle {
    height: 5px;
    background: var(--border);
    cursor: ns-resize;
    flex-shrink: 0;
    transition: background 0.15s;
  }

  .resize-handle:hover { background: var(--accent); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--red);
    color: #fff;
    padding: 12px 20px;
    border-radius: var(--radius);
    font-size: 14px;
    z-index: 9999;
    max-width: 420px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } }

  /* Leaflet popup override */
  .leaflet-popup-content-wrapper {
    background: var(--surface2) !important;
    color: var(--text) !important;
    border-radius: var(--radius) !important;
    border: 1px solid var(--border) !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4) !important;
  }

  .leaflet-popup-tip { background: var(--surface2) !important; }

  .leaflet-popup-content {
    margin: 12px !important;
    font-size: 13px !important;
    line-height: 1.5 !important;
  }

  .leaflet-popup-content a { color: var(--accent); }

  .popup-price { font-size: 18px; font-weight: 700; color: var(--accent); }
  .popup-address { color: var(--text-dim); margin-bottom: 6px; }
  .popup-detail { display: flex; justify-content: space-between; gap: 16px; }
  .popup-detail span:first-child { color: var(--text-dim); }

  /* Legend */
  .map-legend {
    background: var(--surface) !important;
    border: 1px solid var(--border) !important;
    border-radius: var(--radius) !important;
    padding: 10px 14px !important;
    color: var(--text) !important;
    font-size: 12px !important;
    line-height: 1.8 !important;
  }

  .map-legend .legend-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-dim);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .legend-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* API analysis echo */
  .api-analysis {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 14px;
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--text-dim);
  }

  .api-analysis strong { color: var(--text); }

  /* Address autocomplete */
  .autocomplete-wrap { position: relative; }

  .autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    max-height: 220px;
    overflow-y: auto;
    z-index: 100;
  }

  .autocomplete-item {
    padding: 8px 10px;
    font-size: 13px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
  }

  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover, .autocomplete-item.active {
    background: rgba(108,140,255,0.15);
  }

  .autocomplete-item .ac-main { color: var(--text); }
  .autocomplete-item .ac-secondary { color: var(--text-dim); font-size: 12px; }
</style>
</head>
<body>

<header>
  <img src="dwellsy-iq-logo.svg" alt="Dwellsy IQ" class="header-logo">
  <div class="api-key-group">
    <label for="apiKey">API Key</label>
    <input type="password" id="apiKey" placeholder="Enter your API key">
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div>
      <div class="section-title">Location</div>
      <div class="form-group" style="margin-bottom:8px">
        <label for="address">Address</label>
        <div class="autocomplete-wrap">
          <input type="text" id="address" placeholder="e.g. 100 Congress Ave, Austin, TX" autocomplete="off">
          <div id="addressSuggestions" class="autocomplete-list hidden"></div>
        </div>
      </div>
      <div style="text-align:center; font-size:11px; color:var(--text-dim); margin-bottom:4px;">or use coordinates</div>
      <div class="form-row">
        <div class="form-group">
          <label for="latitude">Latitude</label>
          <input type="number" id="latitude" step="any" placeholder="30.2672">
        </div>
        <div class="form-group">
          <label for="longitude">Longitude</label>
          <input type="number" id="longitude" step="any" placeholder="-97.7431">
        </div>
      </div>
    </div>

    <div>
      <div class="section-title">Filters</div>
      <div class="form-row" style="margin-bottom:8px">
        <div class="form-group">
          <label for="bedroomsMin">Bedrooms Min</label>
          <input type="number" id="bedroomsMin" min="0" max="10" value="1">
        </div>
        <div class="form-group">
          <label for="bedroomsMax">Bedrooms Max</label>
          <input type="number" id="bedroomsMax" min="0" max="10" value="3">
        </div>
      </div>
      <div class="form-row" style="margin-bottom:8px">
        <div class="form-group">
          <label for="radius">Radius (miles)</label>
          <input type="number" id="radius" min="1" max="50" value="2">
        </div>
        <div class="form-group">
          <label for="months">Months of History</label>
          <input type="number" id="months" min="3" max="12" value="6">
        </div>
      </div>
      <div class="form-group">
        <label>Property Type</label>
        <div class="checkbox-group">
          <label><input type="checkbox" value="apartment" checked> Apartment</label>
          <label><input type="checkbox" value="house" checked> House</label>
          <label><input type="checkbox" value="mobile"> Mobile</label>
        </div>
      </div>
    </div>

    <button class="btn-primary" id="searchBtn" onclick="runSearch()">Search Comps</button>

    <div id="sidebarResults" class="hidden">
      <div class="section-title">Results Summary</div>
      <div id="resultsSummary"></div>
      <button class="btn-secondary" onclick="downloadCSV()">⬇ Download CSV</button>
    </div>
  </aside>

  <div class="main-content" style="position:relative;">
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>
    <div id="map"></div>
    <div class="resize-handle" id="resizeHandle"></div>
    <div class="bottom-panel" id="bottomPanel">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="stats">Statistics</button>
        <button class="tab-btn" data-tab="table">Listings</button>
      </div>
      <div class="tab-content active" id="tab-stats">
        <div id="statsContent">
          <p style="color:var(--text-dim)">Run a search to see statistics.</p>
        </div>
      </div>
      <div class="tab-content" id="tab-table">
        <div class="comps-table-wrap" id="tableContent">
          <p style="color:var(--text-dim)">Run a search to see listings.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ── State ──
let map, markersLayer, compsData = [], charts = {};

// ── Init Map ──
function initMap() {
  map = L.map('map', { zoomControl: true }).setView([39.8283, -98.5795], 4);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://carto.com/">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
    maxZoom: 19
  }).addTo(map);
  markersLayer = L.featureGroup().addTo(map);
}

// ── Color scale for price heatmap ──
function priceColor(price, min, max) {
  const t = max === min ? 0.5 : (price - min) / (max - min);
  // Blue (low) -> Yellow (mid) -> Red (high)
  if (t < 0.5) {
    const s = t * 2;
    const r = Math.round(70 + s * 185);
    const g = Math.round(130 + s * 75);
    const b = Math.round(255 - s * 200);
    return `rgb(${r},${g},${b})`;
  } else {
    const s = (t - 0.5) * 2;
    const r = Math.round(255);
    const g = Math.round(205 - s * 140);
    const b = Math.round(55 - s * 55);
    return `rgb(${r},${g},${b})`;
  }
}

// ── Percentile ──
function percentile(arr, p) {
  const sorted = [...arr].sort((a, b) => a - b);
  const idx = (p / 100) * (sorted.length - 1);
  const lo = Math.floor(idx);
  const hi = Math.ceil(idx);
  if (lo === hi) return sorted[lo];
  return sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
}

// ── Format currency ──
function fmt(n) {
  return '$' + Math.round(n).toLocaleString();
}

// ── Toast ──
function showToast(msg) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 5000);
}

// ── API Call ──
async function runSearch() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showToast('Please enter your API key.'); return; }

  const address = document.getElementById('address').value.trim();
  const lat = parseFloat(document.getElementById('latitude').value);
  const lng = parseFloat(document.getElementById('longitude').value);

  if (!address && (isNaN(lat) || isNaN(lng))) {
    showToast('Please enter an address or lat/lng coordinates.');
    return;
  }

  const body = {
    bedrooms_min: parseInt(document.getElementById('bedroomsMin').value) || 0,
    bedrooms_max: parseInt(document.getElementById('bedroomsMax').value) || 5,
    radius: parseInt(document.getElementById('radius').value) || 2,
    months: parseInt(document.getElementById('months').value) || 6,
    response_type: 'json'
  };

  if (address) {
    body.address = address;
  } else {
    body.latitude = lat;
    body.longitude = lng;
  }

  const types = [...document.querySelectorAll('.checkbox-group input:checked')].map(c => c.value);
  if (types.length > 0 && types.length < 3) body.address_type = types;

  const btn = document.getElementById('searchBtn');
  btn.disabled = true;
  btn.textContent = 'Searching...';
  document.getElementById('loadingOverlay').classList.remove('hidden');

  try {
    console.log('Sending request:', JSON.stringify(body));
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 min timeout

    const isGitHubPages = location.hostname.endsWith('github.io');
    const apiUrl = isGitHubPages
      ? 'https://dwellsy-comps-proxy.jonas-4dd.workers.dev/'
      : 'https://comps-api.dwellsy.com/comps';

    const resp = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify(body),
      signal: controller.signal
    });
    clearTimeout(timeoutId);

    console.log('Response status:', resp.status);

    if (!resp.ok) {
      const errText = await resp.text().catch(() => '');
      let errMsg;
      try { errMsg = JSON.parse(errText).error; } catch(_) { errMsg = errText; }
      throw new Error(errMsg || `HTTP ${resp.status}`);
    }

    btn.textContent = 'Parsing results...';
    const text = await resp.text();
    console.log('Response size:', text.length, 'chars');
    const data = JSON.parse(text);
    compsData = data.comps || [];
    console.log('Comps loaded:', compsData.length);
    renderResults(data);
  } catch (e) {
    if (e.name === 'AbortError') {
      showToast('Request timed out. Try a smaller radius or fewer months.');
    } else {
      showToast(`Error: ${e.message}`);
    }
    console.error('Search error:', e);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Search Comps';
    document.getElementById('loadingOverlay').classList.add('hidden');
  }
}

// ── Download CSV ──
async function downloadCSV() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showToast('Please enter your API key.'); return; }

  const address = document.getElementById('address').value.trim();
  const lat = parseFloat(document.getElementById('latitude').value);
  const lng = parseFloat(document.getElementById('longitude').value);

  const body = {
    bedrooms_min: parseInt(document.getElementById('bedroomsMin').value) || 0,
    bedrooms_max: parseInt(document.getElementById('bedroomsMax').value) || 5,
    radius: parseInt(document.getElementById('radius').value) || 2,
    months: parseInt(document.getElementById('months').value) || 6,
    response_type: 'csv'
  };

  if (address) {
    body.address = address;
  } else {
    body.latitude = lat;
    body.longitude = lng;
  }

  const types = [...document.querySelectorAll('.checkbox-group input:checked')].map(c => c.value);
  if (types.length > 0 && types.length < 3) body.address_type = types;

  const isGitHubPages = location.hostname.endsWith('github.io');
  const apiUrl = isGitHubPages
    ? 'https://dwellsy-comps-proxy.jonas-4dd.workers.dev/'
    : 'https://comps-api.dwellsy.com/comps';

  try {
    const resp = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify(body)
    });

    if (!resp.ok) {
      const errText = await resp.text().catch(() => '');
      let errMsg;
      try { errMsg = JSON.parse(errText).error; } catch(_) { errMsg = errText; }
      throw new Error(errMsg || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    if (!data.url) throw new Error('No CSV URL returned by API');

    const csvResp = await fetch(data.url);
    if (!csvResp.ok) throw new Error(`Failed to download CSV: HTTP ${csvResp.status}`);

    const csv = await csvResp.text();
    const blob = new Blob([csv], { type: 'text/csv' });
    const blobUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = blobUrl;
    const rawAddr = document.getElementById('address').value.trim()
      .replace(/[,.\/#!$%\^&\*;:{}=\-`~()]/g, '').replace(/\s+/g, ' ').trim();
    const addr = rawAddr || `${lat}_${lng}`;
    const now = new Date();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const yy = String(now.getFullYear()).slice(-2);
    const datePart = `${mm}-${dd}-${yy}`;
    a.download = `Dwellsy API Sample_${addr}_${datePart}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(blobUrl);
  } catch (e) {
    showToast(`CSV download failed: ${e.message}`);
  }
}

// ── Render Everything ──
function renderResults(data) {
  renderSummary(data);
  renderMap(data);
  renderStats(data);
  renderTable();
}

// ── Sidebar Summary ──
function renderSummary(data) {
  const el = document.getElementById('sidebarResults');
  el.classList.remove('hidden');
  document.getElementById('resultsSummary').innerHTML = `
    <div class="api-analysis">
      <div><strong>${data.compsCount}</strong> comps found</div>
      <div>Avg Rent: <strong>${fmt(data.analysis.avg_price)}</strong></div>
      <div>Avg $/SF: <strong>$${data.analysis.avg_price_per_square_feet.toFixed(2)}</strong></div>
      <div>Avg Bed/Bath: <strong>${data.analysis.avg_bedrooms} / ${data.analysis.avg_bathrooms}</strong></div>
      <div>Avg Sq Ft: <strong>${data.analysis.avg_square_feet.toLocaleString()}</strong></div>
    </div>
  `;
}

// ── Map ──
function renderMap(data) {
  markersLayer.clearLayers();

  if (compsData.length === 0) return;

  const prices = compsData.map(c => c.listing_amount);
  const minP = Math.min(...prices);
  const maxP = Math.max(...prices);

  // Center marker
  const cLat = data.criteria.latitude;
  const cLng = data.criteria.longitude;

  if (cLat && cLng) {
    const centerIcon = L.divIcon({
      className: '',
      html: `<div style="width:16px;height:16px;background:var(--accent);border:3px solid #fff;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.5);"></div>`,
      iconSize: [16, 16],
      iconAnchor: [8, 8]
    });
    L.marker([cLat, cLng], { icon: centerIcon, zIndexOffset: 1000 })
      .bindPopup('<strong>Search Center</strong>')
      .addTo(markersLayer);

    // Radius circle
    const radiusMiles = data.criteria.radius || 2;
    L.circle([cLat, cLng], {
      radius: radiusMiles * 1609.34,
      color: 'rgba(108,140,255,0.4)',
      fillColor: 'rgba(108,140,255,0.05)',
      fillOpacity: 0.3,
      weight: 1,
      dashArray: '6 4'
    }).addTo(markersLayer);
  }

  // Comp markers
  compsData.forEach(comp => {
    const lat = parseFloat(comp.latitude);
    const lng = parseFloat(comp.longitude);
    if (isNaN(lat) || isNaN(lng)) return;

    const color = priceColor(comp.listing_amount, minP, maxP);
    const icon = L.divIcon({
      className: '',
      html: `<div style="width:10px;height:10px;background:${color};border:2px solid rgba(255,255,255,0.6);border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.4);"></div>`,
      iconSize: [10, 10],
      iconAnchor: [5, 5]
    });

    const addr = [comp.address_1, comp.address_2].filter(Boolean).join(' ');
    const popup = `
      <div class="popup-price">${fmt(comp.listing_amount)}/mo</div>
      <div class="popup-address">${addr}<br>${comp.address_city}, ${comp.address_state} ${comp.address_zip}</div>
      <div class="popup-detail"><span>Type</span><span>${comp.address_type}</span></div>
      <div class="popup-detail"><span>Bed/Bath</span><span>${comp.bedrooms} / ${comp.bathrooms}</span></div>
      <div class="popup-detail"><span>Sq Ft</span><span>${comp.square_feet ? parseInt(comp.square_feet).toLocaleString() : 'N/A'}</span></div>
      <div class="popup-detail"><span>$/SF</span><span>${comp.price_per_sf ? '$' + comp.price_per_sf.toFixed(2) : 'N/A'}</span></div>
      <div class="popup-detail"><span>Distance</span><span>${comp.distance_miles} mi</span></div>
      <div class="popup-detail"><span>Status</span><span>${comp.property_listing_status}</span></div>
      <div style="margin-top:6px"><a href="${comp.url}" target="_blank" rel="noopener">View on Dwellsy</a></div>
    `;

    L.marker([lat, lng], { icon })
      .bindPopup(popup, { maxWidth: 280 })
      .addTo(markersLayer);
  });

  // Fit bounds
  const bounds = markersLayer.getBounds();
  if (bounds.isValid()) {
    map.fitBounds(bounds, { padding: [30, 30] });
  }

  // Legend
  if (map._legend) map.removeControl(map._legend);
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'map-legend');
    div.innerHTML = `
      <div class="legend-title">Rent Price</div>
      <div class="legend-row"><div class="legend-dot" style="background:rgb(70,130,255)"></div> ${fmt(minP)} (Low)</div>
      <div class="legend-row"><div class="legend-dot" style="background:rgb(255,205,55)"></div> ${fmt((minP + maxP) / 2)} (Mid)</div>
      <div class="legend-row"><div class="legend-dot" style="background:rgb(255,65,0)"></div> ${fmt(maxP)} (High)</div>
      <div class="legend-row" style="margin-top:4px"><div class="legend-dot" style="background:var(--accent);border:2px solid #fff;width:14px;height:14px;margin-left:-1px"></div> Search Center</div>
    `;
    return div;
  };
  legend.addTo(map);
  map._legend = legend;
}

// ── Statistics ──
function renderStats(data) {
  if (compsData.length === 0) {
    document.getElementById('statsContent').innerHTML = '<p style="color:var(--text-dim)">No comps found.</p>';
    return;
  }

  const prices = compsData.map(c => c.listing_amount);
  const ppsf = compsData.filter(c => c.price_per_sf).map(c => c.price_per_sf);

  const p20 = percentile(prices, 20);
  const p50 = percentile(prices, 50);
  const p80 = percentile(prices, 80);
  const avg = prices.reduce((a, b) => a + b, 0) / prices.length;

  const ppsf20 = ppsf.length ? percentile(ppsf, 20) : 0;
  const ppsf50 = ppsf.length ? percentile(ppsf, 50) : 0;
  const ppsf80 = ppsf.length ? percentile(ppsf, 80) : 0;
  const ppsfAvg = ppsf.length ? ppsf.reduce((a, b) => a + b, 0) / ppsf.length : 0;

  document.getElementById('statsContent').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">20th Percentile Rent</div>
        <div class="stat-value">${fmt(p20)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Median Rent (50th)</div>
        <div class="stat-value">${fmt(p50)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Rent</div>
        <div class="stat-value">${fmt(avg)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">80th Percentile Rent</div>
        <div class="stat-value">${fmt(p80)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">20th Pctl $/SF</div>
        <div class="stat-value">$${ppsf20.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Median $/SF</div>
        <div class="stat-value">$${ppsf50.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average $/SF</div>
        <div class="stat-value">$${ppsfAvg.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">80th Pctl $/SF</div>
        <div class="stat-value">$${ppsf80.toFixed(2)}</div>
      </div>
    </div>
    <div class="charts-row">
      <div class="chart-container"><canvas id="rentChart"></canvas></div>
      <div class="chart-container"><canvas id="ppsfChart"></canvas></div>
    </div>
  `;

  renderCharts(prices, ppsf, { p20, p50, p80, avg }, { p20: ppsf20, p50: ppsf50, p80: ppsf80, avg: ppsfAvg });
}

// ── Charts ──
function renderCharts(prices, ppsf, rentStats, ppsfStats) {
  // Destroy old charts
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  const chartDefaults = {
    color: '#8b8fa8',
    borderColor: '#2e3348',
    font: { family: '-apple-system, BlinkMacSystemFont, sans-serif' }
  };

  // Rent distribution histogram
  const rentBins = buildHistogram(prices, 20);
  charts.rent = new Chart(document.getElementById('rentChart'), {
    type: 'bar',
    data: {
      labels: rentBins.labels,
      datasets: [{
        label: 'Count',
        data: rentBins.counts,
        backgroundColor: 'rgba(108,140,255,0.6)',
        borderColor: 'rgba(108,140,255,0.9)',
        borderWidth: 1,
        borderRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Rent Distribution', color: '#e4e6f0', font: { size: 13, weight: '600' } },
        legend: { display: false },
        annotation: undefined
      },
      scales: {
        x: { ticks: { color: '#8b8fa8', maxRotation: 45, font: { size: 10 } }, grid: { color: '#2e3348' } },
        y: { ticks: { color: '#8b8fa8', font: { size: 10 } }, grid: { color: '#2e3348' }, beginAtZero: true }
      }
    }
  });

  // Price per SF histogram
  const ppsfBins = buildHistogram(ppsf, 20);
  charts.ppsf = new Chart(document.getElementById('ppsfChart'), {
    type: 'bar',
    data: {
      labels: ppsfBins.labels,
      datasets: [{
        label: 'Count',
        data: ppsfBins.counts,
        backgroundColor: 'rgba(76,219,138,0.6)',
        borderColor: 'rgba(76,219,138,0.9)',
        borderWidth: 1,
        borderRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Rent per Sq Ft Distribution', color: '#e4e6f0', font: { size: 13, weight: '600' } },
        legend: { display: false }
      },
      scales: {
        x: { ticks: { color: '#8b8fa8', maxRotation: 45, font: { size: 10 } }, grid: { color: '#2e3348' } },
        y: { ticks: { color: '#8b8fa8', font: { size: 10 } }, grid: { color: '#2e3348' }, beginAtZero: true }
      }
    }
  });
}

function buildHistogram(values, numBins) {
  if (!values.length) return { labels: [], counts: [] };
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = max - min || 1;
  const binSize = range / numBins;
  const counts = new Array(numBins).fill(0);
  const labels = [];

  for (let i = 0; i < numBins; i++) {
    const lo = min + i * binSize;
    const hi = lo + binSize;
    if (max <= 100) {
      labels.push(`$${lo.toFixed(2)}`);
    } else {
      labels.push(`$${Math.round(lo).toLocaleString()}`);
    }
  }

  values.forEach(v => {
    let idx = Math.floor((v - min) / binSize);
    if (idx >= numBins) idx = numBins - 1;
    counts[idx]++;
  });

  return { labels, counts };
}

// ── Table ──
let sortCol = 'listing_amount';
let sortDir = 1;

function renderTable() {
  if (compsData.length === 0) {
    document.getElementById('tableContent').innerHTML = '<p style="color:var(--text-dim)">No comps found.</p>';
    return;
  }

  const sorted = [...compsData].sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'string' && !isNaN(parseFloat(va))) { va = parseFloat(va); vb = parseFloat(vb); }
    if (va == null) return 1;
    if (vb == null) return -1;
    if (typeof va === 'string') return va.localeCompare(vb) * sortDir;
    return (va - vb) * sortDir;
  });

  const arrow = (col) => sortCol === col ? (sortDir === 1 ? ' ▲' : ' ▼') : '';

  const cols = [
    { key: 'address_1', label: 'Address' },
    { key: 'address_city', label: 'City' },
    { key: 'address_type', label: 'Type' },
    { key: 'bedrooms', label: 'Bed' },
    { key: 'bathrooms', label: 'Bath' },
    { key: 'square_feet', label: 'Sq Ft' },
    { key: 'listing_amount', label: 'Rent' },
    { key: 'price_per_sf', label: '$/SF' },
    { key: 'distance_miles', label: 'Dist (mi)' },
    { key: 'property_listing_status', label: 'Status' },
    { key: 'year_built', label: 'Year' }
  ];

  let html = '<table class="comps-table"><thead><tr>';
  cols.forEach(c => {
    html += `<th onclick="sortTable('${c.key}')">${c.label}<span class="sort-arrow">${arrow(c.key)}</span></th>`;
  });
  html += '<th>Link</th></tr></thead><tbody>';

  sorted.forEach(comp => {
    const addr = [comp.address_1, comp.address_2].filter(Boolean).join(' ');
    const statusClass = comp.property_listing_status === 'active' ? 'active' : 'inactive';
    html += `<tr>
      <td>${addr}</td>
      <td>${comp.address_city}</td>
      <td>${comp.address_type}</td>
      <td>${comp.bedrooms}</td>
      <td>${comp.bathrooms}</td>
      <td>${comp.square_feet ? parseInt(comp.square_feet).toLocaleString() : '—'}</td>
      <td>${fmt(comp.listing_amount)}</td>
      <td>${comp.price_per_sf ? '$' + comp.price_per_sf.toFixed(2) : '—'}</td>
      <td>${comp.distance_miles}</td>
      <td><span class="status-badge ${statusClass}">${comp.property_listing_status}</span></td>
      <td>${comp.year_built || '—'}</td>
      <td><a href="${comp.url}" target="_blank" rel="noopener" style="color:var(--accent)">View</a></td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('tableContent').innerHTML = html;
}

function sortTable(col) {
  if (sortCol === col) {
    sortDir *= -1;
  } else {
    sortCol = col;
    sortDir = 1;
  }
  renderTable();
}

// ── Tabs ──
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

// ── Resizable bottom panel ──
(function () {
  const handle = document.getElementById('resizeHandle');
  const panel = document.getElementById('bottomPanel');
  let startY, startH;

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    startY = e.clientY;
    startH = panel.offsetHeight;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  function onMove(e) {
    const delta = startY - e.clientY;
    const newH = Math.max(120, Math.min(window.innerHeight - 200, startH + delta));
    panel.style.height = newH + 'px';
    map.invalidateSize();
  }

  function onUp() {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
  }
})();

// ── Enter key on inputs triggers search ──
document.querySelectorAll('.sidebar input').forEach(input => {
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') runSearch();
  });
});

// ── Address Autocomplete (Mapbox) ──
(function () {
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiamJvcmRvIiwiYSI6ImNtbHI2ajRxNjA4aDEzZXByNnkzaXNvcmwifQ.1gNXtshlQu2ORL4AE0KegA';
  const addressInput = document.getElementById('address');
  const suggestionsEl = document.getElementById('addressSuggestions');
  let debounceTimer = null;
  let activeIdx = -1;

  addressInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    const q = addressInput.value.trim();
    if (q.length < 3) { closeSuggestions(); return; }
    debounceTimer = setTimeout(() => fetchSuggestions(q), 300);
  });

  addressInput.addEventListener('keydown', e => {
    const items = suggestionsEl.querySelectorAll('.autocomplete-item');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIdx = Math.min(activeIdx + 1, items.length - 1);
      updateActive(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIdx = Math.max(activeIdx - 1, 0);
      updateActive(items);
    } else if (e.key === 'Enter' && activeIdx >= 0) {
      e.preventDefault();
      e.stopPropagation();
      items[activeIdx].click();
    } else if (e.key === 'Escape') {
      closeSuggestions();
    }
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.autocomplete-wrap')) closeSuggestions();
  });

  async function fetchSuggestions(query) {
    try {
      const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&country=us&types=address&limit=5&autocomplete=true`;
      const resp = await fetch(url);
      if (!resp.ok) return;
      const data = await resp.json();
      renderSuggestions(data.features || []);
    } catch (_) {}
  }

  function renderSuggestions(features) {
    if (!features.length) { closeSuggestions(); return; }
    activeIdx = -1;
    suggestionsEl.innerHTML = features.map((f, i) => {
      const parts = f.place_name.split(',');
      const main = parts[0].trim();
      const secondary = parts.slice(1).join(',').trim();
      return `<div class="autocomplete-item" data-idx="${i}" data-place-name="${f.place_name.replace(/"/g, '&quot;')}">
        <div class="ac-main">${main}</div>
        <div class="ac-secondary">${secondary}</div>
      </div>`;
    }).join('');
    suggestionsEl.classList.remove('hidden');

    suggestionsEl.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        addressInput.value = item.dataset.placeName;
        closeSuggestions();
        addressInput.focus();
      });
    });
  }

  function updateActive(items) {
    items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
  }

  function closeSuggestions() {
    suggestionsEl.classList.add('hidden');
    suggestionsEl.innerHTML = '';
    activeIdx = -1;
  }
})();

// ── Init ──
initMap();
</script>
</body>
</html>
